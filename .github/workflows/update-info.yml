name: Update info_.js

on:
  schedule:
    - cron: '0 0 * * *'   # UTC 기준, 매일 00:00에 실행 (한국 시간 09:00)
  workflow_dispatch:      # 수동 실행 가능

jobs:
  update-info:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch games data from Cloudflare D1 API
        env:
          API_URL: ${{ secrets.API_URL }}
          MY_API_KEY: ${{ secrets.MY_API_KEY }}
        run: |
          echo "1️⃣ Fetching games data from Cloudflare D1..."
          RESPONSE=$(curl -fsS -H "X-API-KEY: $MY_API_KEY" "$API_URL") || { echo "❌ API fetch failed"; exit 1; }
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "❌ API returned success: false"
            exit 1
          fi
          GAMES_DATA=$(echo "$RESPONSE" | jq -c '.data')

          echo "2️⃣ Writing info_.js..."
          echo "window.GAMES_DB_DATA =" > info_.js
          echo "$GAMES_DATA" | jq '.' >> info_.js
          echo ";" >> info_.js

          echo "✅ Generated info_.js. First 30 lines:"
          head -n 30 info_.js

      - name: Commit and push if changed
        env:
          GIT_USER_NAME: hwanmailing
          GIT_USER_EMAIL: hwanmailing@github.com
        run: |
          echo "3️⃣ Configuring git..."
          git config user.name "$GIT_USER_NAME"
          git config user.email "$GIT_USER_EMAIL"

          echo "4️⃣ Checking for changes..."
          if git diff --quiet info_.js; then
            echo "ℹ️ No changes in info_.js, skipping commit."
          else
            git add info_.js
            git commit -m "testing info"
            git push
            echo "✅ Successfully pushed updated info_.js"
          fi