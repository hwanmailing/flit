name: Update info_.js

on:
  schedule:
    - cron: '0 0 * * *'   # UTC 기준, 매일 00:00에 실행 (한국 시간 09:00)
  workflow_dispatch:      # 수동 실행 가능

jobs:
  update-info:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch games data from Cloudflare D1 API
        env:
          API_URL: ${{ secrets.API_URL }}
        run: |
          echo "Fetching games data from Cloudflare D1..."
          RESPONSE=$(curl -fsS "$API_URL") || { echo "API fetch failed"; exit 1; }
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "API returned success: false"
            exit 1
          fi
          GAMES_DATA=$(echo "$RESPONSE" | jq -c '.data')

          echo "window.GAMES_DB_DATA =" > info_.js
          echo "$GAMES_DATA" | jq '.' >> info_.js
          echo ";" >> info_.js

          echo "Generated info_.js:"
          head -n 30 info_.js

      - name: Commit and push if changed
        env:
          GIT_USER_NAME: hwanmailing
          GIT_USER_EMAIL: hwanmailing@github.com
        run: |
          git config user.name "$GIT_USER_NAME"
          git config user.email "$GIT_USER_EMAIL"
          if git diff --quiet info_.js; then
            echo "No changes in info_.js, skipping commit."
          else
            git add info_.js
            git commit -m "chore: auto update info_.js with latest D1 data [skip ci]"
            git push
            echo "Successfully pushed updated info_.js"
