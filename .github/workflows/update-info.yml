name: Test Update info_.js

on:
  workflow_dispatch:  # 수동 실행만, 스케줄 제외

jobs:
  test-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Test API fetch
        env:
          API_URL: ${{ secrets.API_URL }}
        run: |
          echo "1️⃣ Testing API fetch..."
          RESPONSE=$(curl -fsS "$API_URL") || { echo "❌ API fetch failed"; exit 1; }
          echo "✅ API fetch succeeded"
          echo "Sample response:"
          echo "$RESPONSE" | head -n 5

      - name: Test parsing JSON
        run: |
          echo "2️⃣ Testing JSON parsing..."
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success') || { echo "❌ JSON parse failed"; exit 1; }
          echo "API success value: $SUCCESS"
          if [ "$SUCCESS" != "true" ]; then
            echo "❌ API returned success: false"
            exit 1
          fi
          GAMES_DATA=$(echo "$RESPONSE" | jq -c '.data')
          echo "✅ JSON parsed. Sample data:"
          echo "$GAMES_DATA" | head -n 5

      - name: Test writing info_.js
        run: |
          echo "3️⃣ Testing writing info_.js..."
          echo "window.GAMES_DB_DATA =" > info_.js
          echo "$GAMES_DATA" | jq '.' >> info_.js
          echo ";" >> info_.js
          echo "✅ info_.js created. First 10 lines:"
          head -n 10 info_.js

      - name: Test git commit (dry-run)
        run: |
          echo "4️⃣ Testing git diff..."
          git config user.name "test-user"
          git config user.email "test@example.com"
          if git diff --quiet info_.js; then
            echo "No changes detected. ✅"
          else
            echo "Changes detected. Would commit. ✅"
          fi
