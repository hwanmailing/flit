name: Update comments_.js

on:
  schedule:
    - cron: '15 */1 * * *'
  workflow_dispatch:

jobs:
  update-comments:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Generate comments_.js files
        env:
          GAME_LIST_URL: ${{ secrets.GAME_LIST_URL }}
          MY_API_KEY: ${{ secrets.MY_API_KEY }}
          COMMENT_LANGS: en
          COMMENT_LIMIT: 200
        run: |
          node - <<'NODE'
          const fs = require('fs/promises');
          const path = require('path');

          (async () => {
            try {
              const apiKey = process.env.MY_API_KEY;
              if (!apiKey) {
                throw new Error('MY_API_KEY secret/environment variable is not configured.');
              }

              const gamesEndpointEnv = process.env.GAME_LIST_URL;
              if (!gamesEndpointEnv) {
                throw new Error('GAME_LIST_URL secret/environment variable is not configured.');
              }

              const gamesUrl = new URL(gamesEndpointEnv.trim());
              const commentsBaseUrl = new URL(gamesUrl.toString());
              commentsBaseUrl.pathname = commentsBaseUrl.pathname.replace(/\/catalog\/?$/, '');

              const langsEnv = process.env.COMMENT_LANGS || 'en';
              const langs = langsEnv.split(',').map((lang) => lang.trim()).filter(Boolean);
              if (langs.length === 0) {
                langs.push('en');
              }

              const limitEnv = parseInt(process.env.COMMENT_LIMIT, 10);
              const commentLimit = Number.isFinite(limitEnv) && limitEnv > 0 ? limitEnv : 200;

              const gamesResponse = await fetch(gamesUrl.toString(), {
                headers: {
                  'X-API-KEY': apiKey
                }
              });
              if (!gamesResponse.ok) {
                throw new Error(`Failed to fetch games list: HTTP ${gamesResponse.status}`);
              }
              const gamesPayload = await gamesResponse.json();
              if (!gamesPayload || gamesPayload.success !== true) {
                throw new Error(`Games API returned success=${gamesPayload && gamesPayload.success}`);
              }

              const gamesList = Array.isArray(gamesPayload.data)
                ? gamesPayload.data
                : Array.isArray(gamesPayload.games)
                  ? gamesPayload.games
                  : [];

              if (!Array.isArray(gamesList) || gamesList.length === 0) {
                console.log('‚ÑπÔ∏è  No games returned from API. Nothing to update.');
                return;
              }

              const repoRoot = process.cwd();
              const outputRoot = path.join(repoRoot, 'TestWebsite', 'games');
              let totalFiles = 0;
              let totalComments = 0;

              for (const game of gamesList) {
                const gameId = game.id || game.game_id;
                if (!gameId) continue;

                const gameCategory = (game.category || game.game_category || 'Uncategorized').trim() || 'Uncategorized';

                for (const lang of langs) {
                  const commentsUrl = new URL(commentsBaseUrl.toString());
                  commentsUrl.search = '';
                  commentsUrl.pathname = commentsUrl.pathname.replace(/\/$/, '');
                  commentsUrl.pathname += `/${encodeURIComponent(gameId)}/comments`;
                  commentsUrl.searchParams.set('lang', lang);
                  commentsUrl.searchParams.set('limit', String(commentLimit));

                  const commentsResponse = await fetch(commentsUrl.toString(), {
                    headers: {
                      'X-API-KEY': apiKey
                    }
                  });
                  if (!commentsResponse.ok) {
                    console.warn(`‚ö†Ô∏è  Failed to fetch comments for ${gameId} (${lang}): HTTP ${commentsResponse.status}`);
                    continue;
                  }

                  let commentsPayload;
                  try {
                    commentsPayload = await commentsResponse.json();
                  } catch (error) {
                    console.warn(`‚ö†Ô∏è  Invalid JSON for ${gameId} (${lang}): ${error.message}`);
                    continue;
                  }

                  if (commentsPayload.success === false) {
                    console.warn(`‚ö†Ô∏è  API returned success=false for ${gameId} (${lang}): ${commentsPayload.message || 'unknown error'}`);
                    continue;
                  }

                  const comments = Array.isArray(commentsPayload.comments)
                    ? commentsPayload.comments
                    : Array.isArray(commentsPayload.data)
                      ? commentsPayload.data
                      : [];

                  const relativeDir = lang === 'en'
                    ? path.join(gameCategory, gameId)
                    : path.join(gameCategory, gameId, lang);

                  const outputDir = path.join(outputRoot, relativeDir);
                  await fs.mkdir(outputDir, { recursive: true });
                  const outputPath = path.join(outputDir, 'comments_.js');

                  const fileContent = `window.GAME_COMMENTS = ${JSON.stringify(comments, null, 2)};\n`;
                  await fs.writeFile(outputPath, fileContent, 'utf8');

                  console.log(`üìù ${gameId} (${lang}) -> ${path.join('TestWebsite', 'games', relativeDir, 'comments_.js')} [${comments.length} comments]`);
                  totalFiles += 1;
                  totalComments += comments.length;
                }
              }

              console.log(`‚úÖ Generated ${totalFiles} comments_.js files (${totalComments} comments total).`);
            } catch (error) {
              console.error('‚ùå Failed to generate comments_.js files:', error);
              process.exit(1);
            }
          })();
          NODE

      - name: Commit and push if changed
        env:
          GIT_USER_NAME: hwanmailing
          GIT_USER_EMAIL: hwanmailing@github.com
        run: |
          git config user.name "$GIT_USER_NAME"
          git config user.email "$GIT_USER_EMAIL"

          if git diff --quiet -- TestWebsite/games; then
            echo "‚ÑπÔ∏è No changes detected. Skipping commit."
          else
            git add TestWebsite/games
            git commit -m "testing comments"
            git push
            echo "‚úÖ comments_.js files updated and pushed."
          fi
